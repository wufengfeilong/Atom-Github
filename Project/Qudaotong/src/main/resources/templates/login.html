<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="renderer" content="webkit">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>渠道通移动管理系统第１品牌</title>
<meta name="keywords" content="">
<meta name="description" content="">
<link rel="stylesheet" th:href="@{css/reset.css}">
<link rel="stylesheet" th:href="@{css/lib.css}">
<link rel="stylesheet" th:href="@{css/login.css}">

</head>
<body id="login" style="background-image: url(images/1.jpg);">
	<div class="header">
		<div class="header-wrap">
			<h1 class="header-logo">
				<a href="">渠道通</a>
			</h1>
		</div>
	</div>
	<div class="container">
		<div class="link-con">
			<a id="loginLink" target="_blank"
				style="background: url(images/2.png;) right center/70% no-repeat;">

			</a>
		</div>
		<div class="form-con">
			<div class="my-form">
				<form id="myForm" autocomplete="off" novalidate="novalidate"
					method="POST" th:action="@{/userLogin}" th:object="${user}">
					<input style="display: none" type="text"
						name="fakeusernameremembered"> <input
						style="display: none" type="password"
						name="fakepasswordremembered">
					<div class="control-box">
						<div class="warn" id="warn"></div>
						<div class="control-form">
							<input type="text" name="username" id="username"
								th:field="*{name}" tabindex="1" class="ui-input"
								placeholder="请输入用户名" autocomplete="off">
						</div>
						<div class="control-form">
							<input type="password" name="password" id="password"
								th:field="*{password}" tabindex="2" class="ui-input"
								placeholder="请输入密码" autocomplete="off">
						</div>

						<div class="control-form o-form">
							<label class="remember-name">
								<div class="icheck icheckbox_flat-blue"
									style="position: relative;">
									<input id="checkeds" type="checkbox" tabindex="3"
										name="rememberName" value="1"
										style="position: absolute; opacity: 0;">
									<ins class="iCheck-helper"
										style="position: absolute; top: 0%; left: 0%; display: block; width: 100%; height: 100%; margin: 0px; padding: 0px; background: rgb(255, 255, 255); border: 0px; opacity: 0;"></ins>
								</div>
								<span>自动登录</span>
							</label>
							<!-- <a class="forget-pwd" th:href="@{/findPassword}">忘记密码？</a> -->
							<a class="forget-pwd" th:href="@{/logout}">注销</a>
						</div>
						<div class="control-form">
							<input type="button" onclick="save();" id="loginBtn"
								class="ui-btn ui-btn-blue" tabindex="4" value="登录">
						</div>
					</div>
				</form>
				<div class="down-con">
					<a class="register-a" th:href="@{/register}"><em
						class="ui-icon-register"></em>注册</a>
				</div>
			</div>
		</div>
	</div>
	<input type="hidden" name="service" value="ydh-web">
	<input type="hidden" name="relayState" value="">

	<input type="hidden" id="appUrl" value="https://sso.dinghuo123.com">
	<input type="hidden" id="loginErrorCount" value="">
	<script type="text/javascript" th:src="@{js/jquery.js}"></script>
	<script type="text/javascript" th:src="@{js/common/jquery.cookie.js}"></script>
	<script type="text/javascript" async="" th:src="@{js/vds.js}"></script>
	<script type="text/javascript" th:src="@{js/login-util.js?}"></script>
	<script type="text/javascript" th:src="@{js/jquery.defaultvalue.js}"></script>
	<script type="text/javascript" th:src="@{js/jquery.validate.js}"></script>
	<script type="text/javascript" th:src="@{js/icheck.js}"></script>
	<script type="text/javascript" th:src="@{js/growingio-pc.js}"></script>
	<script type="text/javascript" th:src="@{js/jQuery.md5.js}"></script>

	<script type="text/javascript">
		//cookie用来记住密码，自动登录
		$(document).ready(function() {
			if ($.cookie("rmbUser") == "true") {
				$("#checkeds").attr("checked", true);
				$("#username").val($.cookie("username"));
				$("#password").val($.cookie("password"));
			}
		});

		//记住用户名密码
		function save() {
			/* $("#myForm").submit();//保存,触发提交按钮  */
			if ($("#checkeds").attr("checked")) {
				var str_username = $("#username").val();
				var str_password = $("#password").val();
				$.cookie("rmbUser", "true", {
					expires : 7
				}); //存储一个带7天期限的cookie
				$.cookie("username", str_username, {
					expires : 7
				});
				$.cookie("password", str_password, {
					expires : 7
				});
			} else {
				$.cookie("rmbUser", "false", {
					expire : -1
				});
				$.cookie("username", "", {
					expires : -1
				});
				$.cookie("password", "", {
					expires : -1
				});
			}
			//登录密码加密
			var password = $("#password").val();
			//加密成MD5
			var passwd = $.md5(password);
			var name = $("#username").val();
			$.ajax({
				type : "POST", //请求类型
				url : "userLogin",
				data : {
					password : passwd,
					name : name
				}, //传递的参数
				dataType : "text", //返回的数据类型
				success : function(data) { //data就是返回的json类型的数据
					alert(data);
					if (data == 1) {
						alert('username or password NOT correct');
					} else {
						alert('登录成功')
						//   location.href= "/Qudaotong/userLoginPlus?name="+name;
						location.href = "/Qudaotong/userLoginPlus?username="
								+ name;
					}

				},
			/*  error:function(data){
			  alert(data+"失败");
			 } */
			});

		};
		function check() {
			// 用户名验证
			if ($("#username").val() == "") {
				$("#username").tips({
					side : 3,
					msg : '请您输入用户名',
					bg : '#AE81FF',
					time : 3
				});
				$("#username").focus();
				return false;
			}

			// 密码验证
			if ($("#password").val() == "") {
				$("#password").tips({
					side : 3,
					msg : '请您输入密码',
					bg : '#AE81FF',
					time : 3
				});
				$("#password").focus();
				return false;
			}
			return true;
		}

		var THISPAGE = {};
		$(function() {
			THISPAGE = {
				init : function() {
					this.errorTime = !!$("#loginErrorCount").val() ? parseInt($(
							"#loginErrorCount").val())
							: 0;
					this.addEvent();
				},
				addEvent : function() {
					var _self = this;
					$(window).on('resize', function() {
						var CH = document.body.clientHeight;
						if (CH < 800) {
							$("#loginLink").css({
								"backgroundSize" : "70%"
							});
						} else {
							$("#loginLink").css({
								"backgroundSize" : null
							});
						}
					});
					$(window).trigger('resize');
					$(document).on(
							'keyup',
							function(e) {
								e.preventDefault();
								if (e.keyCode === 13) {
									if (e.target.name === 'password'
											|| e.target.name === 'verifyCode') {
										$("#loginBtn").trigger('click');
									} else {
										var tabIndex = e.target.tabIndex;
										tabIndex++;
										$("input[tabIndex=" + tabIndex + "]")
												.focus();
									}
								}
							});
					//记住的用户名
					var u = $.cookie("username");
					if (u) {
						$("#username").val(u);
					}
					//动画
					//$('.my-form').one('webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend', function(){
					//	$('#loginLink').addClass('animated fadeInLeft');
					//});
					//记住用户名
					$(".remember-name").iCheck({
						checkboxClass : 'icheck icheckbox_flat-blue'
					});

					//IE8
					$(".ui-input").defaultValue();

					//刷新验证码
					$(".auth-image").click(function(e) {
						$(this).attr('src', LOGIN.getVerifyCode());
					});

					if (_self.errorTime >= 3) {
						var $img = $(".auth-image");
						$img.parents('.control-form').show();
						$img.attr('src', LOGIN.getVerifyCode());
					}

					$("#myForm").validate({
						onfocusin : function(element, event) {
							var e = $("#warn");
							e.html("");
						},
						onfocusout : function(element, event) {
							$(element).valid();
						},
						focusCleanup : true,
						success : "success",
						onkeyup : false,
						ignore : ":hidden",
						errorPlacement : function(label, element) {
							var e = $("#warn");
							e.append(label);
						},
						rules : {
							username : {
								required : true
							},
							password : {
								required : true
							},
							verifyCode : {
								required : true,
								maxlength : 4,
								minlength : 4
							}
						},
						messages : {
							username : {
								required : "登录用户名不能为空！"
							},
							password : {
								required : "登录密码不能为空！"
							},
							verifyCode : {
								required : "验证码不能为空！",
								maxlength : "图片识别码不正确！",
								minlength : "图片识别码不正确！"
							}
						}
					});

					$("#loginBtn")
							.click(
									function(e) {
										var _this = $(this);
										e.preventDefault();
										$("#warn").html("");
										var formValid = $("#myForm").valid();
										$("#warn").find('.success').remove();
										if (formValid) {
											var postData = {
												service : $(
														"input[name=service]")
														.val(),
												relayState : $(
														"input[name=relayState]")
														.val(),
												username : $.trim($(
														"input[name=username]")
														.val()),
												password : $.trim($(
														"input[name=password]")
														.val())
											};
											if (_self.errorTime >= 3) {
												var $img = $(".auth-image");
												$img.parents('.control-form')
														.show();
												$img.attr('src', LOGIN
														.getVerifyCode());
												postData.verfCode = $
														.trim($(
																"input[name=verifyCode]")
																.val());
											}
											_this.attr("disabled", true).val(
													"正在登录...");
											LOGIN.clearCrossDomainCookie();
											LOGIN
													.auth(
															postData,
															{
																success : function(
																		r) {
																	$(
																			"input[name=lt]")
																			.val(
																					r);
																	if ($(
																			"input[name=rememberName]")
																			.get(
																					0).checked) {
																		$
																				.cookie(
																						"username",
																						postData.username,
																						{
																							expires : 30,
																							path : '/',
																							domain : 'dinghuo123.com'
																						});
																	}
																	$(
																			"#loginForm")
																			.submit();
																},
																error : function(
																		code, r) {
																	var e = $("#warn");
																	e.html("");
																	e.append(r);
																	_this
																			.attr(
																					"disabled",
																					null)
																			.val(
																					"登录");
																	_self.errorTime++;
																	if (_self.errorTime >= 3) {
																		var $img = $(".auth-image");
																		$img
																				.parents(
																						'.control-form')
																				.show();
																		$img
																				.attr(
																						'src',
																						LOGIN
																								.getVerifyCode());
																	}
																	if (_self.errorTime >= 5) {
																		$(
																				"#warn")
																				.html(
																						'')
																				.html(
																						'连续输错密码五次,请30分钟后再试!');
																		_this
																				.attr(
																						"disabled",
																						true)
																				.val(
																						"请30分钟后再试");
																	}
																	if (code === 'limit') {
																		_this
																				.attr(
																						"disabled",
																						true)
																				.val(
																						"请30分钟后再试");
																	}
																}
															});
										}
									});
				}
			};
			THISPAGE.init();

		})
	</script>



</body>
</html>